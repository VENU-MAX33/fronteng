<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kabaddi Scoreboard - Sports Arena Hub</title>
    <link rel="stylesheet" href="../style.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
</head>

<body>

    <header>
        <div class="container">
            <nav>
                <div class="logo">
                    <span style="color: var(--kabaddi-primary);">ü§º</span> Kabaddi Scoring
                </div>
                <div class="nav-links">
                    <a href="#" onclick="if(confirm('Exit match?')) window.location.href='admin.html'">Exit Match</a>
                </div>
            </nav>
        </div>
    </header>

    <!-- Toss Section -->
    <section class="container" id="tossSection" style="padding-top: 2rem;">
        <div class="form-container" style="max-width: 500px;">
            <h2 style="margin-top: 0;">ü§º Toss Details</h2>

            <div class="form-group">
                <label>Who won the toss?</label>
                <div style="display: flex; gap: 1rem;">
                    <div class="toss-option" id="tossTeam1" onclick="selectTossWinner(1)"
                        style="flex:1; padding: 1.5rem; text-align: center; cursor: pointer; border: 2px solid var(--border); border-radius: 8px;">
                        <span id="tossTeam1Name">Team 1</span>
                    </div>
                    <div class="toss-option" id="tossTeam2" onclick="selectTossWinner(2)"
                        style="flex:1; padding: 1.5rem; text-align: center; cursor: pointer; border: 2px solid var(--border); border-radius: 8px;">
                        <span id="tossTeam2Name">Team 2</span>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label>Winner chose to:</label>
                <div style="display: flex; gap: 1rem;">
                    <div class="toss-option" id="chooseRaid" onclick="selectTossChoice('raid')"
                        style="flex:1; padding: 1.5rem; text-align: center; cursor: pointer; border: 2px solid var(--border); border-radius: 8px;">
                        üèÉ Raid First
                    </div>
                    <div class="toss-option" id="chooseCourt" onclick="selectTossChoice('court')"
                        style="flex:1; padding: 1.5rem; text-align: center; cursor: pointer; border: 2px solid var(--border); border-radius: 8px;">
                        üõ°Ô∏è Court Side
                    </div>
                </div>
            </div>

            <button type="button" class="btn btn-kabaddi" style="width: 100%;" onclick="startScoring()">
                Start Match ‚Üí
            </button>
        </div>
    </section>

    <!-- Main Scoreboard -->
    <section class="container hidden" id="scoreboardSection" style="padding-top: 2rem;">

        <!-- Timer & Score Display -->
        <div class="scoreboard kabaddi">

            <!-- Teams and Score -->
            <div
                style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 2rem; align-items: center; text-align: center;">
                <div>
                    <div style="font-size: 1.1rem; opacity: 0.8;" id="team1NameDisplay">Team 1</div>
                    <div class="score-big" style="font-size: 4rem;" id="team1Score">0</div>
                </div>
                <div style="font-size: 1.5rem; opacity: 0.5;">VS</div>
                <div>
                    <div style="font-size: 1.1rem; opacity: 0.8;" id="team2NameDisplay">Team 2</div>
                    <div class="score-big" style="font-size: 4rem;" id="team2Score">0</div>
                </div>
            </div>

            <!-- Timer Section -->
            <div class="timer-display" style="margin-top: 2rem;">
                <div id="halfLabel" style="font-size: 0.9rem; opacity: 0.7;">1st Half</div>
                <div class="timer-big" id="matchTimer">20:00</div>
                <div style="margin-top: 1rem;">
                    <div style="font-size: 0.9rem; opacity: 0.7;">Raid Timer</div>
                    <div class="raid-timer" id="raidTimer">30</div>
                </div>
                <div class="timer-controls">
                    <button class="timer-btn start" id="timerStartBtn" onclick="toggleTimer()">
                        <i class="fas fa-play"></i> Start
                    </button>
                    <button class="timer-btn pause" onclick="resetRaidTimer()">
                        <i class="fas fa-redo"></i> Reset Raid
                    </button>
                </div>
            </div>

            <!-- Current Raider -->
            <div class="player-selector" style="margin-top: 1.5rem;">
                <label>Current Raider</label>
                <select id="currentRaider">
                    <option value="">Select Raider</option>
                </select>
            </div>
        </div>

        <!-- Two Team Scoring Panels -->
        <div class="team-panels" style="margin-top: 2rem;">

            <!-- Team 1 Panel -->
            <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: var(--shadow-sm);">
                <h3 style="text-align: center; color: var(--kabaddi-primary); margin-bottom: 1.5rem;" id="panel1Name">
                    Team 1</h3>

                <!-- Raid Points -->
                <div class="scoring-section">
                    <h4 style="color: var(--text-light); font-size: 0.85rem; margin-bottom: 0.5rem;">Raid Points (R)
                    </h4>
                    <div class="score-buttons" style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button class="score-btn raid" onclick="scoreRaid(1, 1)">1</button>
                        <button class="score-btn raid" onclick="scoreRaid(1, 2)">2</button>
                        <button class="score-btn raid" onclick="scoreRaid(1, 3)">3</button>
                        <button class="score-btn raid" onclick="scoreRaid(1, 4)">4</button>
                        <button class="score-btn raid" onclick="scoreRaid(1, 5)">5</button>
                        <button class="score-btn raid" onclick="scoreRaid(1, 6)">6</button>
                        <button class="score-btn raid" onclick="scoreRaid(1, 7)">7</button>
                    </div>
                </div>

                <!-- Bonus -->
                <div class="scoring-section" style="margin-top: 1rem;">
                    <h4 style="color: var(--text-light); font-size: 0.85rem; margin-bottom: 0.5rem;">Bonus (B) +1</h4>
                    <button class="score-btn bonus" onclick="scoreBonus(1)">+1 Bonus</button>
                </div>

                <!-- Tackle Points -->
                <div class="scoring-section" style="margin-top: 1rem;">
                    <h4 style="color: var(--text-light); font-size: 0.85rem; margin-bottom: 0.5rem;">Tackle Points</h4>
                    <div class="score-buttons" style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button class="score-btn tackle" onclick="scoreTackle(1, 1)">T (1)</button>
                        <button class="score-btn super" onclick="scoreSuperTackle(1)">SP (2)</button>
                    </div>
                </div>

                <!-- Self Out -->
                <div class="scoring-section" style="margin-top: 1rem;">
                    <h4 style="color: var(--text-light); font-size: 0.85rem; margin-bottom: 0.5rem;">Self Out (SO) -
                        Points to Opponent</h4>
                    <div class="score-buttons" style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button class="score-btn selfout" onclick="scoreSelfOut(1, 1)">1</button>
                        <button class="score-btn selfout" onclick="scoreSelfOut(1, 2)">2</button>
                        <button class="score-btn selfout" onclick="scoreSelfOut(1, 3)">3</button>
                        <button class="score-btn selfout" onclick="scoreSelfOut(1, 4)">4</button>
                        <button class="score-btn selfout" onclick="scoreSelfOut(1, 5)">5</button>
                        <button class="score-btn selfout" onclick="scoreSelfOut(1, 6)">6</button>
                        <button class="score-btn selfout" onclick="scoreSelfOut(1, 7)">7</button>
                    </div>
                </div>

                <!-- All Out -->
                <div class="scoring-section" style="margin-top: 1rem;">
                    <h4 style="color: var(--text-light); font-size: 0.85rem; margin-bottom: 0.5rem;">All Out (AL) +2
                    </h4>
                    <button class="score-btn allout" onclick="scoreAllOut(1)">+2 All Out</button>
                </div>
            </div>

            <!-- Team 2 Panel -->
            <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: var(--shadow-sm);">
                <h3 style="text-align: center; color: var(--kabaddi-primary); margin-bottom: 1.5rem;" id="panel2Name">
                    Team 2</h3>

                <!-- Raid Points -->
                <div class="scoring-section">
                    <h4 style="color: var(--text-light); font-size: 0.85rem; margin-bottom: 0.5rem;">Raid Points (R)
                    </h4>
                    <div class="score-buttons" style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button class="score-btn raid" onclick="scoreRaid(2, 1)">1</button>
                        <button class="score-btn raid" onclick="scoreRaid(2, 2)">2</button>
                        <button class="score-btn raid" onclick="scoreRaid(2, 3)">3</button>
                        <button class="score-btn raid" onclick="scoreRaid(2, 4)">4</button>
                        <button class="score-btn raid" onclick="scoreRaid(2, 5)">5</button>
                        <button class="score-btn raid" onclick="scoreRaid(2, 6)">6</button>
                        <button class="score-btn raid" onclick="scoreRaid(2, 7)">7</button>
                    </div>
                </div>

                <!-- Bonus -->
                <div class="scoring-section" style="margin-top: 1rem;">
                    <h4 style="color: var(--text-light); font-size: 0.85rem; margin-bottom: 0.5rem;">Bonus (B) +1</h4>
                    <button class="score-btn bonus" onclick="scoreBonus(2)">+1 Bonus</button>
                </div>

                <!-- Tackle Points -->
                <div class="scoring-section" style="margin-top: 1rem;">
                    <h4 style="color: var(--text-light); font-size: 0.85rem; margin-bottom: 0.5rem;">Tackle Points</h4>
                    <div class="score-buttons" style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button class="score-btn tackle" onclick="scoreTackle(2, 1)">T (1)</button>
                        <button class="score-btn super" onclick="scoreSuperTackle(2)">SP (2)</button>
                    </div>
                </div>

                <!-- Self Out -->
                <div class="scoring-section" style="margin-top: 1rem;">
                    <h4 style="color: var(--text-light); font-size: 0.85rem; margin-bottom: 0.5rem;">Self Out (SO) -
                        Points to Opponent</h4>
                    <div class="score-buttons" style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button class="score-btn selfout" onclick="scoreSelfOut(2, 1)">1</button>
                        <button class="score-btn selfout" onclick="scoreSelfOut(2, 2)">2</button>
                        <button class="score-btn selfout" onclick="scoreSelfOut(2, 3)">3</button>
                        <button class="score-btn selfout" onclick="scoreSelfOut(2, 4)">4</button>
                        <button class="score-btn selfout" onclick="scoreSelfOut(2, 5)">5</button>
                        <button class="score-btn selfout" onclick="scoreSelfOut(2, 6)">6</button>
                        <button class="score-btn selfout" onclick="scoreSelfOut(2, 7)">7</button>
                    </div>
                </div>

                <!-- All Out -->
                <div class="scoring-section" style="margin-top: 1rem;">
                    <h4 style="color: var(--text-light); font-size: 0.85rem; margin-bottom: 0.5rem;">All Out (AL) +2
                    </h4>
                    <button class="score-btn allout" onclick="scoreAllOut(2)">+2 All Out</button>
                </div>
            </div>
        </div>

        <!-- Half Time / Match End -->
        <div id="halfTime" class="hidden"
            style="text-align: center; padding: 3rem; background: white; border-radius: 12px; margin-top: 2rem;">
            <h2>Half Time!</h2>
            <p style="font-size: 1.3rem; margin: 1rem 0;" id="halfTimeSummary"></p>
            <button class="btn btn-kabaddi" onclick="startSecondHalf()">Start 2nd Half</button>
        </div>

        <div id="matchEnd" class="hidden"
            style="text-align: center; padding: 3rem; background: white; border-radius: 12px; margin-top: 2rem;">
            <h2>üèÜ Match Complete!</h2>
            <p style="font-size: 1.5rem; font-weight: 700; margin: 1rem 0;" id="matchResult"></p>
            <button class="btn" onclick="finishMatch()">Save & Exit</button>
        </div>
    </section>

    <footer style="margin-top: 3rem;">
        <div class="container">
            <p>üèÜ Sports Arena Hub</p>
        </div>
    </footer>

    <script src="../js/config.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        // Match State
        let matchId = '';
        let team1 = { id: '', name: '', score: 0, players: [] };
        let team2 = { id: '', name: '', score: 0, players: [] };
        let toss = { winner: 0, choice: '' };
        let half = 1;
        let halfDuration = 20; // minutes

        // Timer State
        let matchTimeRemaining = 0; // in seconds
        let raidTimeRemaining = 30;
        let timerInterval = null;
        let raidInterval = null;
        let isTimerRunning = false;

        document.addEventListener('DOMContentLoaded', async () => {
            // No auth required - open access

            const params = new URLSearchParams(window.location.search);
            matchId = params.get('id');

            if (matchId) {
                await loadMatchData();
            }
        });

        async function loadMatchData() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/matches/${matchId}`);
                if (response.ok) {
                    const match = await response.json();
                    team1 = { id: match.team1_id, name: match.team1_name, score: 0, players: match.team1_players || [] };
                    team2 = { id: match.team2_id, name: match.team2_name, score: 0, players: match.team2_players || [] };
                    halfDuration = match.config?.half_duration || 20;
                    matchTimeRemaining = halfDuration * 60;

                    document.getElementById('tossTeam1Name').textContent = team1.name;
                    document.getElementById('tossTeam2Name').textContent = team2.name;
                    updateTimerDisplay();
                }
            } catch (error) {
                console.error('Error loading match:', error);
            }
        }

        function selectTossWinner(team) {
            toss.winner = team;
            document.getElementById('tossTeam1').style.borderColor = team === 1 ? 'var(--kabaddi-primary)' : 'var(--border)';
            document.getElementById('tossTeam1').style.background = team === 1 ? '#fff7ed' : 'white';
            document.getElementById('tossTeam2').style.borderColor = team === 2 ? 'var(--kabaddi-primary)' : 'var(--border)';
            document.getElementById('tossTeam2').style.background = team === 2 ? '#fff7ed' : 'white';
        }

        function selectTossChoice(choice) {
            toss.choice = choice;
            document.getElementById('chooseRaid').style.borderColor = choice === 'raid' ? 'var(--kabaddi-primary)' : 'var(--border)';
            document.getElementById('chooseRaid').style.background = choice === 'raid' ? '#fff7ed' : 'white';
            document.getElementById('chooseCourt').style.borderColor = choice === 'court' ? 'var(--kabaddi-primary)' : 'var(--border)';
            document.getElementById('chooseCourt').style.background = choice === 'court' ? '#fff7ed' : 'white';
        }

        function startScoring() {
            if (!toss.winner || !toss.choice) {
                alert('Please complete toss details');
                return;
            }

            // Setup UI
            document.getElementById('team1NameDisplay').textContent = team1.name;
            document.getElementById('team2NameDisplay').textContent = team2.name;
            document.getElementById('panel1Name').textContent = team1.name;
            document.getElementById('panel2Name').textContent = team2.name;

            // Populate raider dropdown
            const raiderSel = document.getElementById('currentRaider');
            const allPlayers = [...team1.players.map(p => ({ ...p, team: 1 })), ...team2.players.map(p => ({ ...p, team: 2 }))];
            raiderSel.innerHTML = '<option value="">Select Raider</option>' +
                allPlayers.map(p => `<option value="${p.name}">[${p.team === 1 ? team1.name : team2.name}] ${p.name}</option>`).join('');

            // Show scoreboard
            document.getElementById('tossSection').classList.add('hidden');
            document.getElementById('scoreboardSection').classList.remove('hidden');

            // Save toss
            saveToss();
        }

        async function saveToss() {
            try {
                await fetch(`${API_BASE_URL}/api/matches/${matchId}/toss`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(typeof getAuthHeaders === 'function' ? getAuthHeaders() : {})
                    },
                    body: JSON.stringify({
                        winner: toss.winner === 1 ? team1.name : team2.name,
                        choice: toss.choice
                    })
                });
            } catch (error) {
                console.error('Error saving toss:', error);
            }
        }

        // Timer Functions
        function toggleTimer() {
            if (isTimerRunning) {
                pauseTimer();
            } else {
                startTimer();
            }
        }

        function startTimer() {
            isTimerRunning = true;
            document.getElementById('timerStartBtn').innerHTML = '<i class="fas fa-pause"></i> Pause';

            timerInterval = setInterval(() => {
                matchTimeRemaining--;
                updateTimerDisplay();

                if (matchTimeRemaining <= 0) {
                    pauseTimer();
                    if (half === 1) {
                        showHalfTime();
                    } else {
                        showMatchEnd();
                    }
                }
            }, 1000);

            startRaidTimer();
        }

        function pauseTimer() {
            isTimerRunning = false;
            document.getElementById('timerStartBtn').innerHTML = '<i class="fas fa-play"></i> Start';
            clearInterval(timerInterval);
            clearInterval(raidInterval);
        }

        function startRaidTimer() {
            raidTimeRemaining = 30;
            updateRaidTimerDisplay();

            raidInterval = setInterval(() => {
                raidTimeRemaining--;
                updateRaidTimerDisplay();

                if (raidTimeRemaining <= 0) {
                    // Raid time expired - raider out
                    raidTimeRemaining = 30;
                    updateRaidTimerDisplay();
                }
            }, 1000);
        }

        function resetRaidTimer() {
            raidTimeRemaining = 30;
            updateRaidTimerDisplay();
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(matchTimeRemaining / 60);
            const seconds = matchTimeRemaining % 60;
            document.getElementById('matchTimer').textContent =
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function updateRaidTimerDisplay() {
            document.getElementById('raidTimer').textContent = raidTimeRemaining;
            const raidEl = document.getElementById('raidTimer');
            if (raidTimeRemaining <= 10) {
                raidEl.style.color = '#ef4444';
            } else {
                raidEl.style.color = '#fb923c';
            }
        }

        // Scoring Functions
        function scoreRaid(team, points) {
            if (team === 1) {
                team1.score += points;
            } else {
                team2.score += points;
            }
            updateScoreDisplay();
            resetRaidTimer();
            saveScore('raid', team, points);
        }

        function scoreBonus(team) {
            if (team === 1) {
                team1.score += 1;
            } else {
                team2.score += 1;
            }
            updateScoreDisplay();
            saveScore('bonus', team, 1);
        }

        function scoreTackle(team, points) {
            if (team === 1) {
                team1.score += points;
            } else {
                team2.score += points;
            }
            updateScoreDisplay();
            resetRaidTimer();
            saveScore('tackle', team, points);
        }

        function scoreSuperTackle(team) {
            if (team === 1) {
                team1.score += 2;
            } else {
                team2.score += 2;
            }
            updateScoreDisplay();
            resetRaidTimer();
            saveScore('super_tackle', team, 2);
        }

        function scoreSelfOut(team, points) {
            // Self out gives points to opposing team
            if (team === 1) {
                team2.score += points;
            } else {
                team1.score += points;
            }
            updateScoreDisplay();
            resetRaidTimer();
            saveScore('self_out', team, points);
        }

        function scoreAllOut(team) {
            if (team === 1) {
                team1.score += 2;
            } else {
                team2.score += 2;
            }
            updateScoreDisplay();
            saveScore('all_out', team, 2);
        }

        function updateScoreDisplay() {
            document.getElementById('team1Score').textContent = team1.score;
            document.getElementById('team2Score').textContent = team2.score;
        }

        function showHalfTime() {
            document.getElementById('halfTimeSummary').textContent =
                `${team1.name}: ${team1.score} | ${team2.name}: ${team2.score}`;
            document.getElementById('halfTime').classList.remove('hidden');
        }

        function startSecondHalf() {
            half = 2;
            matchTimeRemaining = halfDuration * 60;
            document.getElementById('halfLabel').textContent = '2nd Half';
            document.getElementById('halfTime').classList.add('hidden');
            updateTimerDisplay();
        }

        function showMatchEnd() {
            let result = '';
            if (team1.score > team2.score) {
                result = `${team1.name} wins by ${team1.score - team2.score} points!`;
            } else if (team2.score > team1.score) {
                result = `${team2.name} wins by ${team2.score - team1.score} points!`;
            } else {
                result = 'Match Tied!';
            }
            document.getElementById('matchResult').textContent = result;
            document.getElementById('matchEnd').classList.remove('hidden');
        }

        async function saveScore(type, team, points) {
            try {
                await fetch(`${API_BASE_URL}/api/matches/${matchId}/score`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(typeof getAuthHeaders === 'function' ? getAuthHeaders() : {})
                    },
                    body: JSON.stringify({
                        half,
                        team1_score: team1.score,
                        team2_score: team2.score,
                        event: { type, team, points },
                        raider: document.getElementById('currentRaider').value
                    })
                });
            } catch (error) {
                console.error('Error saving score:', error);
            }
        }

        async function finishMatch() {
            try {
                await fetch(`${API_BASE_URL}/api/matches/${matchId}/complete`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(typeof getAuthHeaders === 'function' ? getAuthHeaders() : {})
                    },
                    body: JSON.stringify({
                        result: document.getElementById('matchResult').textContent,
                        team1_score: team1.score,
                        team2_score: team2.score
                    })
                });
                window.location.href = 'live_score.html';
            } catch (error) {
                console.error('Error finishing match:', error);
                window.location.href = 'live_score.html';
            }
        }
    </script>
</body>

</html>