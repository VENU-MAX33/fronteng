<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cricket Scoreboard - Sports Arena Hub</title>
    <link rel="stylesheet" href="../style.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
</head>

<body>

    <header>
        <div class="container">
            <nav>
                <div class="logo">
                    <span style="color: var(--cricket-primary);">üèè</span> Cricket Scoring
                </div>
                <div class="nav-links">
                    <a href="#" onclick="if(confirm('Exit match?')) window.location.href='admin.html'">Exit Match</a>
                </div>
            </nav>
        </div>
    </header>

    <!-- Toss Section (shown first) -->
    <section class="container" id="tossSection" style="padding-top: 2rem;">
        <div class="form-container" style="max-width: 500px;">
            <h2 style="margin-top: 0;">üèè Toss Details</h2>

            <div class="form-group">
                <label>Who won the toss?</label>
                <div class="toss-options" style="display: flex; gap: 1rem;">
                    <div class="toss-option" id="tossTeam1" onclick="selectTossWinner(1)"
                        style="flex:1; padding: 1.5rem; text-align: center; cursor: pointer; border: 2px solid var(--border); border-radius: 8px;">
                        <span id="tossTeam1Name">Team 1</span>
                    </div>
                    <div class="toss-option" id="tossTeam2" onclick="selectTossWinner(2)"
                        style="flex:1; padding: 1.5rem; text-align: center; cursor: pointer; border: 2px solid var(--border); border-radius: 8px;">
                        <span id="tossTeam2Name">Team 2</span>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label>Winner chose to:</label>
                <div class="toss-options" style="display: flex; gap: 1rem;">
                    <div class="toss-option" id="chooseBat" onclick="selectTossChoice('bat')"
                        style="flex:1; padding: 1.5rem; text-align: center; cursor: pointer; border: 2px solid var(--border); border-radius: 8px;">
                        üèè Bat First
                    </div>
                    <div class="toss-option" id="chooseBowl" onclick="selectTossChoice('bowl')"
                        style="flex:1; padding: 1.5rem; text-align: center; cursor: pointer; border: 2px solid var(--border); border-radius: 8px;">
                        ‚öæ Bowl First
                    </div>
                </div>
            </div>

            <button type="button" class="btn btn-cricket" style="width: 100%;" onclick="startScoring()">
                Start Scoring ‚Üí
            </button>
        </div>
    </section>

    <!-- Main Scoreboard -->
    <section class="container hidden" id="scoreboardSection" style="padding-top: 2rem;">

        <!-- Score Display -->
        <div class="scoreboard cricket">
            <div class="score-display">
                <div class="teams-display">
                    <span id="battingTeamName">Batting Team</span>
                    <span style="opacity: 0.5; margin: 0 0.5rem;">vs</span>
                    <span id="bowlingTeamName" style="opacity: 0.7;">Bowling Team</span>
                </div>
                <div class="score-big">
                    <span id="runs">0</span>/<span id="wickets">0</span>
                </div>
                <div class="overs-display">
                    Overs: <span id="oversDisplay">0.0</span> / <span id="totalOvers">10</span>
                </div>
                <div id="inningsLabel" style="margin-top: 0.5rem; opacity: 0.7;">1st Innings</div>

                <!-- Target display for 2nd innings -->
                <div id="targetDisplay" class="hidden"
                    style="margin-top: 1rem; background: rgba(255,255,255,0.1); padding: 0.75rem 1.5rem; border-radius: 20px; display: inline-block;">
                    Target: <span id="target">0</span> | Need <span id="runsNeeded">0</span> in <span
                        id="ballsRemaining">0</span> balls
                </div>
            </div>

            <!-- Current Players -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1.5rem;">
                <div class="player-selector">
                    <label>Striker</label>
                    <select id="striker" onchange="updatePlayers()">
                        <option value="">Select Batsman</option>
                    </select>
                </div>
                <div class="player-selector">
                    <label>Non-Striker</label>
                    <select id="nonStriker" onchange="updatePlayers()">
                        <option value="">Select Batsman</option>
                    </select>
                </div>
            </div>
            <div class="player-selector" style="margin-top: 1rem;">
                <label>Bowler</label>
                <select id="bowler" onchange="updatePlayers()">
                    <option value="">Select Bowler</option>
                </select>
            </div>

            <!-- Ball History -->
            <div class="over-history" id="overHistory">
                <!-- Ball bubbles appear here -->
            </div>

            <!-- Extras Summary -->
            <div
                style="display: flex; justify-content: center; gap: 2rem; margin-top: 1rem; opacity: 0.8; font-size: 0.9rem;">
                <span>Wides: <strong id="widesTotal">0</strong></span>
                <span>No Balls: <strong id="noballsTotal">0</strong></span>
                <span>Extras: <strong id="extrasTotal">0</strong></span>
            </div>
        </div>

        <!-- Scoring Controls -->
        <div style="max-width: 600px; margin: 0 auto;">
            <h3 style="text-align: center; margin-bottom: 1rem; color: var(--text-dark);">Score Runs</h3>
            <div class="controls-grid">
                <button class="control-btn btn-run" onclick="scoreBall(0)">0</button>
                <button class="control-btn btn-run" onclick="scoreBall(1)">1</button>
                <button class="control-btn btn-run" onclick="scoreBall(2)">2</button>
                <button class="control-btn btn-run" onclick="scoreBall(3)">3</button>
                <button class="control-btn btn-four" onclick="scoreBall(4)">4</button>
                <button class="control-btn btn-six" onclick="scoreBall(6)">6</button>
            </div>

            <!-- Extras -->
            <h3 style="text-align: center; margin: 1.5rem 0 1rem; color: var(--text-dark);">Extras</h3>
            <div style="display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap;">
                <button class="control-btn btn-extra" onclick="showExtraPanel('wide')" style="padding: 1rem 2rem;">
                    Wide (W)
                </button>
                <button class="control-btn btn-extra" onclick="showExtraPanel('noball')" style="padding: 1rem 2rem;">
                    No Ball (NB)
                </button>
                <button class="control-btn btn-out" onclick="showWicketPanel()" style="padding: 1rem 2rem;">
                    OUT (W)
                </button>
            </div>

            <!-- Wide Panel -->
            <div id="widePanel" class="extra-panel" style="background: #fff7ed; margin-top: 1rem; text-align: center;">
                <h4 style="color: var(--kabaddi-primary);">Wide + Runs</h4>
                <div class="extra-options" style="justify-content: center; gap: 0.5rem;">
                    <button class="control-btn btn-extra" onclick="scoreExtra('wide', 0)"
                        style="padding: 0.75rem 1.25rem;">W</button>
                    <button class="control-btn btn-extra" onclick="scoreExtra('wide', 1)"
                        style="padding: 0.75rem 1.25rem;">W+1</button>
                    <button class="control-btn btn-extra" onclick="scoreExtra('wide', 2)"
                        style="padding: 0.75rem 1.25rem;">W+2</button>
                    <button class="control-btn btn-extra" onclick="scoreExtra('wide', 3)"
                        style="padding: 0.75rem 1.25rem;">W+3</button>
                    <button class="control-btn btn-extra" onclick="scoreExtra('wide', 4)"
                        style="padding: 0.75rem 1.25rem;">W+4</button>
                </div>
                <button onclick="hideExtraPanels()"
                    style="margin-top: 1rem; background: none; border: none; color: var(--text-light); cursor: pointer;">Cancel</button>
            </div>

            <!-- No Ball Panel -->
            <div id="noballPanel" class="extra-panel"
                style="background: #fff7ed; margin-top: 1rem; text-align: center;">
                <h4 style="color: var(--kabaddi-primary);">No Ball + Runs</h4>
                <div class="extra-options" style="justify-content: center; gap: 0.5rem;">
                    <button class="control-btn btn-extra" onclick="scoreExtra('noball', 0)"
                        style="padding: 0.75rem 1.25rem;">NB</button>
                    <button class="control-btn btn-extra" onclick="scoreExtra('noball', 1)"
                        style="padding: 0.75rem 1.25rem;">NB+1</button>
                    <button class="control-btn btn-extra" onclick="scoreExtra('noball', 2)"
                        style="padding: 0.75rem 1.25rem;">NB+2</button>
                    <button class="control-btn btn-extra" onclick="scoreExtra('noball', 3)"
                        style="padding: 0.75rem 1.25rem;">NB+3</button>
                    <button class="control-btn btn-extra" onclick="scoreExtra('noball', 4)"
                        style="padding: 0.75rem 1.25rem;">NB+4</button>
                    <button class="control-btn btn-six" onclick="scoreExtra('noball', 6)"
                        style="padding: 0.75rem 1.25rem;">NB+6</button>
                </div>
                <button onclick="hideExtraPanels()"
                    style="margin-top: 1rem; background: none; border: none; color: var(--text-light); cursor: pointer;">Cancel</button>
            </div>

            <!-- Wicket Panel -->
            <div id="wicketPanel" class="extra-panel"
                style="background: #fef2f2; margin-top: 1rem; text-align: center;">
                <h4 style="color: var(--accent);">Wicket! Select new batsman</h4>
                <select id="newBatsman" style="padding: 0.75rem; margin: 0.5rem;">
                    <option value="">Select incoming batsman</option>
                </select>
                <div style="margin-top: 1rem;">
                    <button class="control-btn btn-out" onclick="confirmWicket()" style="padding: 0.75rem 2rem;">Confirm
                        Wicket</button>
                    <button onclick="hideExtraPanels()"
                        style="margin-left: 1rem; background: none; border: none; color: var(--text-light); cursor: pointer;">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Innings Break -->
        <div id="inningsBreak" class="hidden"
            style="text-align: center; padding: 3rem; background: white; border-radius: 12px; margin-top: 2rem;">
            <h2>Innings Complete!</h2>
            <p style="font-size: 1.3rem; margin: 1rem 0;" id="inningsSummary"></p>
            <button class="btn btn-cricket" onclick="startSecondInnings()">Start 2nd Innings</button>
        </div>

        <!-- Match End -->
        <div id="matchEnd" class="hidden"
            style="text-align: center; padding: 3rem; background: white; border-radius: 12px; margin-top: 2rem;">
            <h2>üèÜ Match Complete!</h2>
            <p style="font-size: 1.5rem; font-weight: 700; margin: 1rem 0;" id="matchResult"></p>
            <button class="btn" onclick="finishMatch()">Save & Exit</button>
        </div>
    </section>

    <footer style="margin-top: 3rem;">
        <div class="container">
            <p>üèÜ Sports Arena Hub</p>
        </div>
    </footer>

    <script src="../js/config.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        // Match State
        let matchId = '';
        let team1 = { id: '', name: '', players: [] };
        let team2 = { id: '', name: '', players: [] };
        let toss = { winner: 0, choice: '' };
        let battingTeam = null;
        let bowlingTeam = null;
        let innings = 1;
        let totalOvers = 10;

        // Score State
        let runs = 0;
        let wickets = 0;
        let balls = 0;
        let wides = 0;
        let noballs = 0;
        let overHistory = [];
        let firstInningsScore = 0;

        // Player tracking
        let outBatsmen = [];

        document.addEventListener('DOMContentLoaded', async () => {
            // No auth required - open access

            const params = new URLSearchParams(window.location.search);
            matchId = params.get('id');

            if (matchId) {
                await loadMatchData();
            }
        });

        async function loadMatchData() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/matches/${matchId}`);
                if (response.ok) {
                    const match = await response.json();
                    team1 = { id: match.team1_id, name: match.team1_name, players: match.team1_players || [] };
                    team2 = { id: match.team2_id, name: match.team2_name, players: match.team2_players || [] };
                    totalOvers = match.config?.total_overs || 10;

                    document.getElementById('tossTeam1Name').textContent = team1.name;
                    document.getElementById('tossTeam2Name').textContent = team2.name;
                    document.getElementById('totalOvers').textContent = totalOvers;
                }
            } catch (error) {
                console.error('Error loading match:', error);
            }
        }

        function selectTossWinner(team) {
            toss.winner = team;
            document.getElementById('tossTeam1').style.borderColor = team === 1 ? 'var(--cricket-primary)' : 'var(--border)';
            document.getElementById('tossTeam1').style.background = team === 1 ? '#f0fdf4' : 'white';
            document.getElementById('tossTeam2').style.borderColor = team === 2 ? 'var(--cricket-primary)' : 'var(--border)';
            document.getElementById('tossTeam2').style.background = team === 2 ? '#f0fdf4' : 'white';
        }

        function selectTossChoice(choice) {
            toss.choice = choice;
            document.getElementById('chooseBat').style.borderColor = choice === 'bat' ? 'var(--cricket-primary)' : 'var(--border)';
            document.getElementById('chooseBat').style.background = choice === 'bat' ? '#f0fdf4' : 'white';
            document.getElementById('chooseBowl').style.borderColor = choice === 'bowl' ? 'var(--cricket-primary)' : 'var(--border)';
            document.getElementById('chooseBowl').style.background = choice === 'bowl' ? '#f0fdf4' : 'white';
        }

        function startScoring() {
            if (!toss.winner || !toss.choice) {
                alert('Please complete toss details');
                return;
            }

            // Determine batting/bowling teams
            if (toss.choice === 'bat') {
                battingTeam = toss.winner === 1 ? team1 : team2;
                bowlingTeam = toss.winner === 1 ? team2 : team1;
            } else {
                bowlingTeam = toss.winner === 1 ? team1 : team2;
                battingTeam = toss.winner === 1 ? team2 : team1;
            }

            document.getElementById('battingTeamName').textContent = battingTeam.name;
            document.getElementById('bowlingTeamName').textContent = bowlingTeam.name;

            // Populate player dropdowns
            populatePlayerDropdowns();

            // Show scoreboard
            document.getElementById('tossSection').classList.add('hidden');
            document.getElementById('scoreboardSection').classList.remove('hidden');

            // Save toss to server
            saveToss();
        }

        function populatePlayerDropdowns() {
            const strikerSel = document.getElementById('striker');
            const nonStrikerSel = document.getElementById('nonStriker');
            const bowlerSel = document.getElementById('bowler');
            const newBatsmanSel = document.getElementById('newBatsman');

            const battingOptions = '<option value="">Select Batsman</option>' +
                battingTeam.players.filter(p => !outBatsmen.includes(p.name)).map(p =>
                    `<option value="${p.name}">${p.name}${p.is_captain ? ' (C)' : ''}</option>`
                ).join('');

            const bowlingOptions = '<option value="">Select Bowler</option>' +
                bowlingTeam.players.map(p =>
                    `<option value="${p.name}">${p.name}${p.is_captain ? ' (C)' : ''}</option>`
                ).join('');

            strikerSel.innerHTML = battingOptions;
            nonStrikerSel.innerHTML = battingOptions;
            newBatsmanSel.innerHTML = battingOptions;
            bowlerSel.innerHTML = bowlingOptions;
        }

        async function saveToss() {
            try {
                await fetch(`${API_BASE_URL}/api/matches/${matchId}/toss`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(typeof getAuthHeaders === 'function' ? getAuthHeaders() : {})
                    },
                    body: JSON.stringify({
                        winner: toss.winner === 1 ? team1.name : team2.name,
                        choice: toss.choice,
                        batting_first: battingTeam.name
                    })
                });
            } catch (error) {
                console.error('Error saving toss:', error);
            }
        }

        function updatePlayers() {
            // Just for UI tracking
        }

        function scoreBall(runsScored) {
            runs += runsScored;
            balls++;

            // Add to over history
            let bubbleClass = '';
            if (runsScored === 4) bubbleClass = 'bubble-4';
            else if (runsScored === 6) bubbleClass = 'bubble-6';

            overHistory.push({ type: 'run', value: runsScored, class: bubbleClass });
            updateOverHistory();
            updateDisplay();

            // Rotate strike on odd runs
            if (runsScored % 2 === 1) {
                rotateStrike();
            }

            // Check over complete
            if (balls % 6 === 0) {
                overComplete();
            }

            // Check innings complete
            checkInningsComplete();

            // Save to server
            saveScore('ball', runsScored);
        }

        function showExtraPanel(type) {
            hideExtraPanels();
            document.getElementById(`${type}Panel`).classList.add('show');
        }

        function showWicketPanel() {
            hideExtraPanels();
            populatePlayerDropdowns(); // Refresh available batsmen
            document.getElementById('wicketPanel').classList.add('show');
        }

        function hideExtraPanels() {
            document.getElementById('widePanel').classList.remove('show');
            document.getElementById('noballPanel').classList.remove('show');
            document.getElementById('wicketPanel').classList.remove('show');
        }

        function scoreExtra(type, extraRuns) {
            if (type === 'wide') {
                runs += 1 + extraRuns;
                wides += 1 + extraRuns;
                overHistory.push({ type: 'wide', value: `W+${extraRuns}`, class: 'bubble-wd' });
            } else if (type === 'noball') {
                runs += 1 + extraRuns;
                noballs += 1 + extraRuns;
                overHistory.push({ type: 'noball', value: `NB+${extraRuns}`, class: 'bubble-nb' });
            }

            // Extras don't count as legal deliveries
            updateOverHistory();
            updateDisplay();
            hideExtraPanels();

            checkInningsComplete();
            saveScore(type, extraRuns);
        }

        function confirmWicket() {
            const newBatsman = document.getElementById('newBatsman').value;
            const striker = document.getElementById('striker').value;

            if (!newBatsman && wickets < 9) {
                alert('Please select incoming batsman');
                return;
            }

            // Mark current striker as out
            outBatsmen.push(striker);

            wickets++;
            balls++;

            overHistory.push({ type: 'wicket', value: 'W', class: 'bubble-w' });
            updateOverHistory();
            updateDisplay();
            hideExtraPanels();

            // Set new batsman
            if (newBatsman) {
                document.getElementById('striker').value = newBatsman;
            }
            populatePlayerDropdowns();

            // Check over complete
            if (balls % 6 === 0) {
                overComplete();
            }

            checkInningsComplete();
            saveScore('wicket', 0);
        }

        function rotateStrike() {
            const striker = document.getElementById('striker').value;
            const nonStriker = document.getElementById('nonStriker').value;
            document.getElementById('striker').value = nonStriker;
            document.getElementById('nonStriker').value = striker;
        }

        function overComplete() {
            // Rotate strike at end of over
            rotateStrike();

            // Clear over history display (start new over)
            overHistory = [];
            updateOverHistory();
        }

        function updateOverHistory() {
            const container = document.getElementById('overHistory');
            container.innerHTML = overHistory.map(ball =>
                `<div class="ball-bubble ${ball.class}">${ball.value}</div>`
            ).join('');
        }

        function updateDisplay() {
            document.getElementById('runs').textContent = runs;
            document.getElementById('wickets').textContent = wickets;

            const completedOvers = Math.floor(balls / 6);
            const ballsInOver = balls % 6;
            document.getElementById('oversDisplay').textContent = `${completedOvers}.${ballsInOver}`;

            document.getElementById('widesTotal').textContent = wides;
            document.getElementById('noballsTotal').textContent = noballs;
            document.getElementById('extrasTotal').textContent = wides + noballs;

            // Update target display in 2nd innings
            if (innings === 2) {
                document.getElementById('runsNeeded').textContent = firstInningsScore + 1 - runs;
                const ballsBowled = balls;
                const totalBalls = totalOvers * 6;
                document.getElementById('ballsRemaining').textContent = totalBalls - ballsBowled;
            }
        }

        function checkInningsComplete() {
            const maxOvers = totalOvers * 6;

            if (innings === 1) {
                // First innings ends when overs done or all out
                if (balls >= maxOvers || wickets >= 10) {
                    firstInningsScore = runs;
                    document.getElementById('inningsSummary').textContent =
                        `${battingTeam.name} scored ${runs}/${wickets} in ${document.getElementById('oversDisplay').textContent} overs`;
                    document.getElementById('inningsBreak').classList.remove('hidden');
                }
            } else {
                // Second innings
                if (runs > firstInningsScore) {
                    // Batting team wins
                    const wicketsLeft = 10 - wickets;
                    document.getElementById('matchResult').textContent =
                        `${battingTeam.name} wins by ${wicketsLeft} wickets!`;
                    document.getElementById('matchEnd').classList.remove('hidden');
                } else if (balls >= maxOvers || wickets >= 10) {
                    // Innings over
                    if (runs === firstInningsScore) {
                        document.getElementById('matchResult').textContent = 'Match Tied!';
                    } else {
                        const margin = firstInningsScore - runs;
                        document.getElementById('matchResult').textContent =
                            `${bowlingTeam.name} wins by ${margin} runs!`;
                    }
                    document.getElementById('matchEnd').classList.remove('hidden');
                }
            }
        }

        function startSecondInnings() {
            innings = 2;

            // Swap teams
            const temp = battingTeam;
            battingTeam = bowlingTeam;
            bowlingTeam = temp;

            // Reset scores
            runs = 0;
            wickets = 0;
            balls = 0;
            wides = 0;
            noballs = 0;
            overHistory = [];
            outBatsmen = [];

            // Update UI
            document.getElementById('battingTeamName').textContent = battingTeam.name;
            document.getElementById('bowlingTeamName').textContent = bowlingTeam.name;
            document.getElementById('inningsLabel').textContent = '2nd Innings';

            document.getElementById('target').textContent = firstInningsScore + 1;
            document.getElementById('runsNeeded').textContent = firstInningsScore + 1;
            document.getElementById('ballsRemaining').textContent = totalOvers * 6;
            document.getElementById('targetDisplay').classList.remove('hidden');

            populatePlayerDropdowns();
            updateDisplay();
            updateOverHistory();

            document.getElementById('inningsBreak').classList.add('hidden');
        }

        async function saveScore(type, value) {
            try {
                await fetch(`${API_BASE_URL}/api/matches/${matchId}/score`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(typeof getAuthHeaders === 'function' ? getAuthHeaders() : {})
                    },
                    body: JSON.stringify({
                        innings,
                        runs,
                        wickets,
                        balls,
                        wides,
                        noballs,
                        event: { type, value },
                        striker: document.getElementById('striker').value,
                        bowler: document.getElementById('bowler').value
                    })
                });
            } catch (error) {
                console.error('Error saving score:', error);
            }
        }

        async function finishMatch() {
            try {
                await fetch(`${API_BASE_URL}/api/matches/${matchId}/complete`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(typeof getAuthHeaders === 'function' ? getAuthHeaders() : {})
                    },
                    body: JSON.stringify({
                        result: document.getElementById('matchResult').textContent
                    })
                });
                window.location.href = 'live_score.html';
            } catch (error) {
                console.error('Error finishing match:', error);
                window.location.href = 'live_score.html';
            }
        }
    </script>
</body>

</html>